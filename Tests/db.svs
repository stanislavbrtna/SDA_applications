function init {
  scr = sys.gui.addScreen();
  sys.os.gui.setMainScr(scr);
  test_name = "DB test 1.0";
  sys.gui.addText(1, 0, 10, 1, test_name, scr);
  result = sys.gui.addText(1, 1, 10, 10, "Result:", scr);
  
  progress = 0;
  tested = 0;
  GLOB_FAIL = 0;
  
  ignore_glob = 0;
  
  if (arg0 == 1) {
    autoreturn = 1;
  }
}

function update {
  if (tested == 0) {
    test();
    if (not ignore_glob) add_result("Final result", GLOB_FAIL);
    tested = 1;
    
    if (autoreturn) {
      sys.os.subRetval(GLOB_FAIL, test_name, 0);
      sys.os.exit();
    }
  }
}

function upd_progress {
  if (progress > 100) {
    progress = 100
  }
  sys.ds.setArea(32, 440, 270, 480);
  sys.ds.fillRect(0, 0, 240, 20, 0);
  sys.ds.fillRect(5, 5, 5 + num(230.0 * (float(progress)/100.0)), 15, sys.ds.mixColor(255, 0, 0));
}

function add_result{
  if (arg1 == 1) {
    sys.gui.setStr(result, sys.gui.getStr(result) + "\n" + arg0 + ": Failed");
    if (not ignore_glob) GLOB_FAIL = 1;
  } else
    sys.gui.setStr(result, sys.gui.getStr(result) + "\n" + arg0 + ": Passed");
}

function cleanup {
  if (sys.fs.exists("test.bdb")) {
     sys.fs.delete("test.bdb");
  }
}

function init_test {
  if (sys.fs.exists("test.bdb")) {
    sys.fs.delete("test.bdb");
  }
}

function test {
  init_test();
  
  if (not GLOB_FAIL) test_open();
  if (not GLOB_FAIL) test_rw();
  if (not GLOB_FAIL) test_index();
  if (not GLOB_FAIL) multi();
  if (not GLOB_FAIL) dropAllRows();
  if (not GLOB_FAIL) test_drop();
  if (not GLOB_FAIL) test_drop2();
  if (not GLOB_FAIL) test_monkey();
}

function test_open {
  local FAIL;
  FAIL = 0;

  # close on empty
  if (sys.fs.db.close() != 0) {
    print("close failed");
    FAIL = 1;
  }
  
  # open non-existing
  if (sys.fs.db.open("test.bdb") != 0) {
    print("open non existing failed");
    FAIL = 1;
  }
  
  if (sys.fs.db.new("test.bdb") != 1) {
    print("new failed");
    FAIL = 1;
  }
  
  if (sys.fs.db.close() != 1) {
    print("close openned failed");
    FAIL = 1;
  }
  
  if (sys.fs.db.open("test.bdb") != 1) {
    print("open existing failed");
    FAIL = 1;
  }
  
  sys.fs.db.close();
  
  add_result("Open, Close", FAIL);
}

function test_rw {
  local FAIL;
  FAIL = 0;
  
  cleanup();
  
  sys.fs.db.new("test.bdb");

  
  sys.fs.db.newTable("test", 6);
    
  sys.fs.db.setColumn(0, "id", 0);
  sys.fs.db.setColumn(1, "name", 1);
  sys.fs.db.setColumn(2, "surname", 1);
  sys.fs.db.setColumn(3, "job", 1);
  sys.fs.db.setColumn(4, "foo", 0);
  sys.fs.db.setColumn(5, "bar", 1);
  
  sys.fs.db.idEnable("id");
  
  array dataCheck[10];

  # fill data
  for (i = 0; i < 10; i++;) {
    sys.fs.db.newRow();
    local name = "Joh" + i;
    local surname = "Doe" + i;
    local job = "job " + i;
    local foo = 0;
    sys.fs.db.setEntryStr("name", name);
    sys.fs.db.setEntryStr("surname", surname);
    sys.fs.db.setEntryStr("job", job);
    
    if (i < 5 or i > 7) {
      foo = 400 + i;
    } else {
      foo = 66;
    }
    
    sys.fs.db.setEntryNum("foo", foo);
    
    if (i == 7) {
      name = "We like tom very much.";
      sys.fs.db.setEntryStr("name", name);
    }
    
    if (i == 8) {
      name = "tom";
      sys.fs.db.setEntryStr("name", name);
    }
    
    if (i == 9) {
      name = "Tom";
      sys.fs.db.setEntryStr("name", name);
    }
    
    dataCheck[i] = i+1 + " " + name + " " + surname + " " + job + " " + foo;
  }
  
  if (sys.fs.db.getRowCount() != 10) {
    FAIL = 1;
    print("Row count faled");
  }
  
  # print output
  sys.fs.db.selectRow(0);
  
  i = 0;
  
  while(1) {
    local data = sys.fs.db.getEntryNum("id", 0)
      + " " + sys.fs.db.getEntryStr("name", "def") 
      + " " + sys.fs.db.getEntryStr("surname", "def")
      + " " + sys.fs.db.getEntryStr("job", "") 
      + " " + sys.fs.db.getEntryNum("foo", 0);
     
    print(data);
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    
    if (data != dataCheck[i]) {
      FAIL = 1;
      print(dataCheck[i]);
      print("Rows read faled");
      
    }
    i++;
  }
  
  sys.fs.db.selectRow(0);
  while(sys.fs.db.selectRowNum("foo", 66)) {
    local data = sys.fs.db.getEntryNum("id", 0)
      + " " + sys.fs.db.getEntryStr("name", "def") 
      + " " + sys.fs.db.getEntryStr("surname", "def")
      + " " + sys.fs.db.getEntryStr("job", "") 
      + " " + sys.fs.db.getEntryNum("foo", 0);
      
    print("Match: " + data);
    
    if (data != dataCheck[5] and data != dataCheck[6] and data != dataCheck[7]) {
      FAIL = 1;
      print("Select Row num failed");
    }
    
    sys.fs.db.nextRow();
  }
  
  #note: selectRowId should rewind the selected row and walk the entire file
  sys.fs.db.selectRowId(3);
  local data = sys.fs.db.getEntryNum("id", 0)
    + " " + sys.fs.db.getEntryStr("name", "def") 
    + " " + sys.fs.db.getEntryStr("surname", "def")
    + " " + sys.fs.db.getEntryStr("job", "") 
    + " " + sys.fs.db.getEntryNum("foo", 0);
    
  print("Match: " + data);
  
  if (data != dataCheck[2]) {
    FAIL = 1;
    print("Select Row id failed");
  }
  
  print("\nSelectRowStr:");
  i = 0;
  sys.fs.db.selectRow(0);
  while(sys.fs.db.selectRowStr("name", "tom", 1, 1)) {
    local data = sys.fs.db.getEntryNum("id", 0)
    + " " + sys.fs.db.getEntryStr("name", "def") 
    + " " + sys.fs.db.getEntryStr("surname", "def")
    + " " + sys.fs.db.getEntryStr("job", "") 
    + " " + sys.fs.db.getEntryNum("foo", 0);
    
    print(data);
  
    if (data != dataCheck[7] and data != dataCheck[8]) {
      FAIL = 1;
      print("Select Row str failed");
    }
    
    if (not sys.fs.db.nextRow()) {
      break
    }
    
    i++;
  }
  
  if ( i == 0) {
    FAIL = 1;
    print("Select Row str failed");
  }
  
  print("SelectRowStr2:");
  i = 0;
  sys.fs.db.selectRow(0); #       full string 0 case sensitive 0
  while(sys.fs.db.selectRowStr("name", "tom", 0, 0)) {
    local data = sys.fs.db.getEntryNum("id", 0)
    + " " + sys.fs.db.getEntryStr("name", "def") 
    + " " + sys.fs.db.getEntryStr("surname", "def")
    + " " + sys.fs.db.getEntryStr("job", "") 
    + " " + sys.fs.db.getEntryNum("foo", 0);
    
    print(data);
  
    if (data != dataCheck[7] and data != dataCheck[8] and data != dataCheck[9]) {
      FAIL = 1;
      print("Select Row num failed (2)");
    }
    
    if (not sys.fs.db.nextRow()) {
      break
    }
    
    i++;
  }
  
  print("SelectRowStr3:");
  i = 0;
  sys.fs.db.selectRow(0);
  while(sys.fs.db.selectRowStr("name", "tom", 1, 0)) {
    local data = sys.fs.db.getEntryNum("id", 0)
    + " " + sys.fs.db.getEntryStr("name", "def") 
    + " " + sys.fs.db.getEntryStr("surname", "def")
    + " " + sys.fs.db.getEntryStr("job", "") 
    + " " + sys.fs.db.getEntryNum("foo", 0);
    
    print(data);
  
    if (data != dataCheck[8] and data != dataCheck[9]) {
      FAIL = 1;
      print("Select Row num failed (3)");
    }
    
    if (not sys.fs.db.nextRow()) {
      break
    }
    
    i++;
  }
  
  add_result("Read, Write", FAIL);
}

function test_index {
  local FAIL;
  FAIL = 0;
  
  cleanup();
  
  print("\nIndexing test");
  
  sys.fs.db.new("test.bdb");

  sys.fs.db.newTable("test", 6);
    
  sys.fs.db.setColumn(0, "id", 0);
  sys.fs.db.setColumn(1, "name", 1);
  sys.fs.db.setColumn(2, "surname", 1);
  sys.fs.db.setColumn(3, "job", 1);
  sys.fs.db.setColumn(4, "foo", 0);
  sys.fs.db.setColumn(5, "bar", 1);
  
  sys.fs.db.idEnable("id");
  
  sys.fs.db.setIndex("id");
  sys.fs.db.setIndex("foo");
  sys.fs.db.setRowIndex(1);
  print("indexing done");
  
  array dataCheck[10];

  # fill data
  for (i = 0; i < 10; i++;) {
    sys.fs.db.newRow();
    local name = "Joh" + i;
    local surname = "Doe" + i;
    local job = "job " + i;
    local foo = 0;
    sys.fs.db.setEntryStr("name", name);
    sys.fs.db.setEntryStr("surname", surname);
    sys.fs.db.setEntryStr("job", job);
    
    if (i < 5 or i > 7) {
      foo = 400 + i;
    } else {
      foo = 66;
    }
    
    sys.fs.db.setEntryNum("foo", foo);
    
    if (i == 7) {
      name = "We like tom very much.";
      sys.fs.db.setEntryStr("name", name);
    }
    
    if (i == 8) {
      name = "tom";
      sys.fs.db.setEntryStr("name", name);
    }
    
    if (i == 9) {
      name = "Tom";
      sys.fs.db.setEntryStr("name", name);
    }
    
    dataCheck[i] = i+1 + " " + name + " " + surname + " " + job + " " + foo;
  }
  
  print("filled data");
  
  sys.fs.db.buildIndex("id");
  sys.fs.db.buildIndex("foo");
  sys.fs.db.buildRowIndex();
  
  print("built index");
  
  sys.fs.db.selectRowId(3);
  local data = sys.fs.db.getEntryNum("id", 0)
    + " " + sys.fs.db.getEntryStr("name", "def") 
    + " " + sys.fs.db.getEntryStr("surname", "def")
    + " " + sys.fs.db.getEntryStr("job", "") 
    + " " + sys.fs.db.getEntryNum("foo", 0);
    
  print("Match: " + data);
  
  if (data != dataCheck[2]) {
    FAIL = 1;
    print("Select Row id failed");
  }
  
  sys.fs.db.selectRow(4);
  local data = sys.fs.db.getEntryNum("id", 0)
    + " " + sys.fs.db.getEntryStr("name", "def") 
    + " " + sys.fs.db.getEntryStr("surname", "def")
    + " " + sys.fs.db.getEntryStr("job", "") 
    + " " + sys.fs.db.getEntryNum("foo", 0);
    
  print("Match: " + data);
  
  if (data != dataCheck[4]) {
    FAIL = 1;
    print("Select Row num failed");
  }
  
  
  
  add_result("Indexing", FAIL);
}

function test_drop {
  local FAIL;
  FAIL = 0;
  
  cleanup();
  
  sys.fs.db.new("test.bdb");
  
  sys.fs.db.newTable("test", 6);
  sys.fs.db.setColumn(0, "id", 0);
  sys.fs.db.setColumn(1, "name", 1);
  sys.fs.db.setColumn(2, "surname", 1);
  sys.fs.db.setColumn(3, "job", 1);
  sys.fs.db.setColumn(4, "foo", 0);
  sys.fs.db.setColumn(5, "bar", 1);
  
  sys.fs.db.idEnable("id");
  
  array dataCheck[10];

  # fill data
  for (i = 0; i < 10; i++;) {
    sys.fs.db.newRow();
    local name = "Joh" + i;
    local surname = "Doe" + i;
    local job = "job " + i;
    local foo = 0;
    sys.fs.db.setEntryStr("name", name);
    sys.fs.db.setEntryStr("surname", surname);
    sys.fs.db.setEntryStr("job", job);
    
    if (i < 5 or i > 7) {
      foo = 400 + i;
    } else {
      foo = 66;
    }
    
    sys.fs.db.setEntryNum("foo", foo);
    
    if (i == 7) {
      name = "We like tom very much.";
      sys.fs.db.setEntryStr("name", name);
    }
    
    if (i == 8) {
      name = "tom";
      sys.fs.db.setEntryStr("name", name);
    }
    
    if (i == 9) {
      name = "Tom";
      sys.fs.db.setEntryStr("name", name);
    }
    
    dataCheck[i] = i+1 + " " + name + " " + surname + " " + job + " " + foo;
  }
  
 
  print("\nDrop:");
  sys.fs.db.selectRow(99);
  if (sys.fs.db.dropRow()) {
    print("fail: drop invalid row did not throw error!");
    FAIL = 1;
  }
 
  print("row_count" + sys.fs.db.getRowCount());
  sys.fs.db.selectRow(4);
  if (not sys.fs.db.dropRow()) {
    print("row drop failed");
    FAIL = 1;
  }
  
  #verify
  i = 0;
  sys.fs.db.selectRow(0);
  
  while(1) {
    local data = sys.fs.db.getEntryNum("id", 0)
      + " " + sys.fs.db.getEntryStr("name", "def") 
      + " " + sys.fs.db.getEntryStr("surname", "def")
      + " " + sys.fs.db.getEntryStr("job", "") 
      + " " + sys.fs.db.getEntryNum("foo", 0);
     
    print(data);
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    
    if(i == 4) {
      i++;
    }
    
    if (data != dataCheck[i]) {
      FAIL = 1;
      print("Rows read faled");
    }
    i++;
  }
  
  add_result("Drop Row", FAIL);
}

function test_drop2 {
  local FAIL;
  FAIL = 0;
  
  cleanup();
  
  print("creating table1");
  sys.fs.db.new("test.bdb");
  
  sys.fs.db.newTable("test", 6);
  sys.fs.db.setColumn(0, "id", 0);
  sys.fs.db.setColumn(1, "name", 1);
  sys.fs.db.setColumn(2, "surname", 1);
  sys.fs.db.setColumn(3, "job", 1);
  sys.fs.db.setColumn(4, "foo", 0);
  sys.fs.db.setColumn(5, "bar", 1);
  sys.fs.db.idEnable("id");
  
  for(i = 0; i < len(dataCheck); i++;) {
    dataCheck[i] = "";
  }

  # fill data in table 1
  for (i = 0; i < 10; i++;) {
    sys.fs.db.newRow();
    local name = "Joh" + i;
    local surname = "Doe" + i;
    local job = "job " + i;
    local foo = 0;
    sys.fs.db.setEntryStr("name", name);
    sys.fs.db.setEntryStr("surname", surname);
    sys.fs.db.setEntryStr("job", job);
    sys.fs.db.setEntryNum("foo", foo);
    dataCheck[i] = i+1 + " " + name + " " + surname + " " + job + " " + foo;
  }

  print("creating table2");
  
  sys.fs.db.newTable("test2", 3);
  sys.fs.db.setColumn(0, "a", 1);
  sys.fs.db.setColumn(1, "b", 1);
  sys.fs.db.setColumn(2, "c", 1);
  
  array dataCheck2[10];

  # fill data in table 2
  for (i = 0; i < 10; i++;) {
    sys.fs.db.newRow();
    local a = "test" + i;
    local b = "textoid" + i;
    local c = "goodJob " + i;
    sys.fs.db.setEntryStr("a", a);
    sys.fs.db.setEntryStr("b", b);
    sys.fs.db.setEntryStr("c", c);
    dataCheck2[i] = a + " " + b + " " + c;
  }

  sys.fs.db.selectTable("test");
  print("\nMultitable/Drop\ntable1:");
  i = 0;
  while(1) {
    local data = sys.fs.db.getEntryNum("id", 0)
      + " " + sys.fs.db.getEntryStr("name", "def") 
      + " " + sys.fs.db.getEntryStr("surname", "def")
      + " " + sys.fs.db.getEntryStr("job", "") 
      + " " + sys.fs.db.getEntryNum("foo", 0);
     
    print(data);
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    
    if (data != dataCheck[i]) {
      FAIL = 1;
      print("Rows read faled");
    }
    i++;
  }
  
  
  sys.fs.db.selectTable("test2");
  print("table2:");
  i = 0;
  while(1) {
    local data = sys.fs.db.getEntryStr("a", "")
      + " " + sys.fs.db.getEntryStr("b", "") 
      + " " + sys.fs.db.getEntryStr("c", "");
     
    print(data);
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    
    if (data != ""+dataCheck2[i]) {
      FAIL = 1;
      print("Rows read faled");
    }
    i++;
  }
  
  sys.fs.db.selectTable("test");
  
  sys.fs.db.selectRow(3);
  sys.fs.db.setEntryStr("surname", "");
  
  sys.fs.db.dropTable();
  
  sys.fs.db.selectTable("test2");
  print("table2:");
  i = 0;
  while(1) {
    local data = sys.fs.db.getEntryStr("a", "")
      + " " + sys.fs.db.getEntryStr("b", "") 
      + " " + sys.fs.db.getEntryStr("c", "");
     
    print(data);
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    
    if (data != ""+dataCheck2[i]) {
      FAIL = 1;
      print("Rows read faled");
    }
    i++;
  }
  
  
  add_result("Drop Table", FAIL);
}

function dropAllRows {
  local FAIL;
  FAIL = 0;
  
  cleanup();
  
  print("creating table1");
  
  sys.fs.db.new("test.bdb");
  
  sys.fs.db.newTable("test", 6);
  sys.fs.db.setColumn(0, "id", 0);
  sys.fs.db.setColumn(1, "name", 1);
  sys.fs.db.setColumn(2, "surname", 1);
  sys.fs.db.setColumn(3, "job", 1);
  sys.fs.db.setColumn(4, "foo", 0);
  sys.fs.db.setColumn(5, "bar", 1);
  sys.fs.db.idEnable("id");
  
  print("creating table2");
  
  sys.fs.db.newTable("test2", 3);
  sys.fs.db.setColumn(0, "a", 1);
  sys.fs.db.setColumn(1, "b", 1);
  sys.fs.db.setColumn(2, "c", 1);
  
  array dataCheck2[10];

  # add some entry to db1
  
  sys.fs.db.selectTable("test");
  sys.fs.db.newRow();
  sys.fs.db.setEntryStr("name", "karel");
  
  # add something to db2
  if(not sys.fs.db.selectTable("test2")) {
    return;
  }
  
  for (i = 0; i < 2; i++;) {
    sys.fs.db.newRow();
    local a = "test" + i;
    local b = "textoid" + i;
    local c = "goodJob " + i;
    sys.fs.db.setEntryStr("a", a);
    sys.fs.db.setEntryStr("b", b);
    sys.fs.db.setEntryStr("c", c);
    dataCheck2[i] = a + " " + b + " " + c;
  }

  sys.fs.db.selectTable("test");
  print("DROP");
  sys.fs.db.dropAllRows();
  
  sys.fs.db.selectTable("test2");
  print("DROP2");
  sys.fs.db.dropAllRows();
  
  sys.fs.db.selectTable("test");
  
  print("add");
  sys.fs.db.newRow();
  sys.fs.db.setEntryStr("name", "karel");
  
  sys.fs.db.selectTable("test2");
  sys.fs.db.newRow();
  sys.fs.db.setEntryStr("a", "karel2");
    
  print("\ncheck:");
  if(not sys.fs.db.selectTable("test")) {
    FAIL = 1;
  }
  
  if(sys.fs.db.getEntryStr("name", "def") != "karel") {
    FAIL = 1;
  }
  
  if(not sys.fs.db.selectTable("test2")) {
    FAIL = 1;
  }
  
  if(sys.fs.db.getEntryStr("a", "def") != "karel2") {
    FAIL = 1;
  }
  
  print("seletct table1");
  sys.fs.db.selectTable("test");
  print("table:");
  i = 0;
  while(1) {
    local data = sys.fs.db.getEntryNum("id", 0)
      + " " + sys.fs.db.getEntryStr("name", "def") 
      + " " + sys.fs.db.getEntryStr("surname", "def")
      + " " + sys.fs.db.getEntryStr("job", "") 
      + " " + sys.fs.db.getEntryNum("foo", 0);
     
    if(data != "1 karel def  0") {
      print("Table1 data mismatch.");
      FAIL = 1;
      add_result("Drop all rows", FAIL);
      return;
    }
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    i++;
  }
  
  print("seletct table2");
  sys.fs.db.selectTable("test2");
  print("table2:");
  i = 0;
  while(1) {
    local data = sys.fs.db.getEntryStr("a", "")
      + " " + sys.fs.db.getEntryStr("b", "") 
      + " " + sys.fs.db.getEntryStr("c", "");
     
    if (data != "karel2  ") {
      print("Data:  " + data);
      print("Check: " + "karel2  ");
    
      FAIL = 1;
      print("Rows read faled");
    }
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    i++;
  }
  
  add_result("Drop all rows", FAIL);
}

function multi {
  local FAIL;
  FAIL = 0;
  
  cleanup();
  
  print("creating table1");
  
  sys.fs.db.new("test.bdb");
  
  sys.fs.db.newTable("test", 6);
  sys.fs.db.setColumn(0, "id", 0);
  sys.fs.db.setColumn(1, "name", 1);
  sys.fs.db.setColumn(2, "surname", 1);
  sys.fs.db.setColumn(3, "job", 1);
  sys.fs.db.setColumn(4, "foo", 0);
  sys.fs.db.setColumn(5, "bar", 1);
  sys.fs.db.idEnable("id");
  
  print("creating table2");
  
  sys.fs.db.newTable("test2", 3);
  sys.fs.db.setColumn(0, "a", 1);
  sys.fs.db.setColumn(1, "b", 1);
  sys.fs.db.setColumn(2, "c", 1);
  
  array dataCheck2[10];

  # add some entry to db1
  
  sys.fs.db.selectTable("test");
  
  # fill data in table 1
  for (i = 0; i < 10; i++;) {
    sys.fs.db.newRow();
    local name = "Joh" + i;
    local surname = "Doe" + i;
    local job = "job " + i;
    local foo = 0;
    sys.fs.db.setEntryStr("name", name);
    sys.fs.db.setEntryStr("surname", surname);
    sys.fs.db.setEntryStr("job", job);
    sys.fs.db.setEntryNum("foo", foo);
    dataCheck[i] = i+1 + " " + name + " " + surname + " " + job + " " + foo;
  }
  
  # add something to db2
  print("SELECT");
  if(not sys.fs.db.selectTable("test2")) {
    FAIL = 1;
    add_result("Multi table", FAIL);
    return;
  }
  
  for (i = 0; i < 2; i++;) {
    sys.fs.db.newRow();
    local a = "test" + i;
    local b = "textoid" + i;
    local c = "goodJob " + i;
    sys.fs.db.setEntryStr("a", a);
    sys.fs.db.setEntryStr("b", b);
    sys.fs.db.setEntryStr("c", c);
    dataCheck2[i] = a + " " + b + " " + c;
  }

  sys.fs.db.selectTable("test");
  print("\ntable1:");
  i = 0;
  while(1) {
    local data = sys.fs.db.getEntryNum("id", 666)
      + " " + sys.fs.db.getEntryStr("name", "def") 
      + " " + sys.fs.db.getEntryStr("surname", "def")
      + " " + sys.fs.db.getEntryStr("job", "") 
      + " " + sys.fs.db.getEntryNum("foo", 666);
     
    if(dataCheck[i] != data) {
      print("Fail!");
      print("Data from db: " + data);
      print("Check:        " + dataCheck[i]);
      FAIL = 1;
      add_result("Multi table", FAIL);
      return;
    }
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    i++;
  }
  
  
  sys.fs.db.selectTable("test2");
  print("table2:");
  i = 0;
  while(1) {
    local data = sys.fs.db.getEntryStr("a", "")
      + " " + sys.fs.db.getEntryStr("b", "") 
      + " " + sys.fs.db.getEntryStr("c", "");
     
    
    if(dataCheck2[i] != data) {
      print("Fail!");
      print("Data:  " + data);
      print("Check: " + dataCheck2[i]);
      FAIL = 1;
      add_result("Multi table", FAIL);
      return;
    }
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    i++;
  }
  
  add_result("Multi table", FAIL);
}

function multi2 {
  local FAIL;
  FAIL = 0;
  
  cleanup();
  
  print("creating table1");
  
  sys.fs.db.new("test.bdb");
  
  sys.fs.db.newTable("test", 6);
  sys.fs.db.setColumn(0, "id", 0);
  sys.fs.db.setColumn(1, "name", 1);
  sys.fs.db.setColumn(2, "surname", 1);
  sys.fs.db.setColumn(3, "job", 1);
  sys.fs.db.setColumn(4, "foo", 0);
  sys.fs.db.setColumn(5, "bar", 1);
  #sys.fs.db.idEnable("id");
  
  print("creating table2");
  
  sys.fs.db.newTable("test2", 3);
  sys.fs.db.setColumn(0, "a", 1);
  sys.fs.db.setColumn(1, "b", 1);
  sys.fs.db.setColumn(2, "c", 1);
  
  print("creating table3");
  
  sys.fs.db.newTable("test2", 3);
  sys.fs.db.setColumn(0, "a", 1);
  sys.fs.db.setColumn(1, "b", 1);
  sys.fs.db.setColumn(2, "c", 1);
  
  
  array dataCheck2[10];

  # add some entry to db1
  
  sys.fs.db.selectTable("test");
  print("ROW ADD");
  sys.fs.db.newRow();
  #sys.fs.db.setEntryStr("name", "karel");
  
  # add something to db2
  print("SELECT");
  if(not sys.fs.db.selectTable("test2")) {
    return;
  }
  
  for (i = 0; i < 2; i++;) {
    sys.fs.db.newRow();
    local a = "test" + i;
    local b = "textoid" + i;
    local c = "goodJob " + i;
    sys.fs.db.setEntryStr("a", a);
    sys.fs.db.setEntryStr("b", b);
    sys.fs.db.setEntryStr("c", c);
    dataCheck2[i] = a + " " + b + " " + c;
  }

  sys.fs.db.selectTable("test");
  print("\ntable1:");
  i = 0;
  while(1) {
    local data = sys.fs.db.getEntryNum("id", 0)
      + " " + sys.fs.db.getEntryStr("name", "def") 
      + " " + sys.fs.db.getEntryStr("surname", "def")
      + " " + sys.fs.db.getEntryStr("job", "") 
      + " " + sys.fs.db.getEntryNum("foo", 0);
     
    print(data);
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    i++;
  }
  
  
  sys.fs.db.selectTable("test2");
  print("table2:");
  i = 0;
  while(1) {
    local data = sys.fs.db.getEntryStr("a", "")
      + " " + sys.fs.db.getEntryStr("b", "") 
      + " " + sys.fs.db.getEntryStr("c", "");
     
    print(data);
    
    if(not sys.fs.db.nextRow()) {
      break;
    }
    
    
    i++;
  }
  
  
  add_result("Multi table", FAIL);
}

function test_rm_ex {
  local FAIL;
  FAIL = 0;
  
  cleanup();
  sys.fs.conf.open("test.cfg");
  
  sys.fs.conf.write("Key1", "value1");
  sys.fs.conf.write("Key2", "value2");
  sys.fs.conf.write("Key3", "value3");
  
  if (sys.fs.conf.exists("Key2") != 1) {
    FAIL = 1;
  }
  
  if (sys.fs.conf.exists("Key_not") != 0) {
    FAIL = 1;
  }
  
  sys.fs.conf.remove("Key2");
  
  if (sys.fs.conf.exists("Key2") != 0) {
    FAIL = 1;
  }
  
  if (sys.fs.conf.read("Key1") != "value1" or sys.fs.conf.read("Key3") != "value3") {
    FAIL = 1;
    print("Remove messed up other keys");
  }
  
  sys.fs.conf.close();
  add_result("Remove, Exists", FAIL);
}


function random_str {
  local new_str;
  local x;
  new_str = "";

  for(x = 0; x < arg0; x++;) {
    new_str = new_str + getcp("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMOPQRSTUVWXYZ0123456789_!@$%&*",
                    sys.os.rnd() % len("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMOPQRSTUVWXYZ0123456789_!@$%&*"));
  }

  return new_str;
}

function test_monkey {
  local FAIL;
  local time;
  FAIL = 0;
  time = sys.time.getUptime();
  
  cleanup();
  
  print("Creating table A");
  
  sys.fs.db.new("test.bdb");
  
  sys.fs.db.newTable("A", 6);
  sys.fs.db.setColumn(0, "id",  0);
  sys.fs.db.setColumn(1, "key", 1)
  sys.fs.db.setColumn(2, "val", 1);
  sys.fs.db.idEnable("id");
  
  print("creating table B");
  
  sys.fs.db.newTable("B", 6);
  sys.fs.db.setColumn(0, "id",  0);
  sys.fs.db.setColumn(1, "key", 1)
  sys.fs.db.setColumn(2, "val", 1);
  sys.fs.db.idEnable("id");
  
  print("creating table C");
  
  sys.fs.db.newTable("C", 6);
  sys.fs.db.setColumn(0, "id",  0);
  sys.fs.db.setColumn(1, "key", 1)
  sys.fs.db.setColumn(2, "val", 1);
  sys.fs.db.idEnable("id");
  
  array keys[51];
  array values[51];
  
  array keys2[51];
  array values2[51];
  
  array keys3[51];
  array values3[51];
  
  # init data
  sys.fs.db.selectTable("A");
  monkey_init(keys, values);
  
  sys.fs.db.selectTable("B");
  monkey_init(keys2, values2);
  
  sys.fs.db.selectTable("C");
  monkey_init(keys3, values3);
  
  # smash
  sys.fs.db.selectTable("A");
  monkey_perf(keys, values);
  
  sys.fs.db.selectTable("B");
  monkey_perf(keys2, values2);
  
  sys.fs.db.selectTable("C");
  monkey_perf(keys3, values3);
  
  # check
  sys.fs.db.selectTable("A");
  monkey_check(keys, values);
  
  sys.fs.db.selectTable("B");
  monkey_check(keys2, values2);
  
  sys.fs.db.selectTable("C");
  monkey_check(keys3, values3);
  
  add_result("Monke (in: " + (sys.time.getUptime() - time) + "s)", FAIL);
}

function monkey_init {
  for (i = 1; i < 51; i++;) {
    arg0[i] = random_str(sys.os.rnd() % 5 + 15);
    arg1[i] = random_str(sys.os.rnd() % 5 + 15);
    
    sys.fs.db.newRow();
    sys.fs.db.setEntryStr("key", arg0[i]);
    sys.fs.db.setEntryStr("val", arg1[i]);
    
    progress = i*2;
    upd_progress();
  }
}

function monkey_perf { # (Keys, values)
  # do random rewrites
  for (i = 0; i < 200; i++;) {
    local id = sys.os.rnd() % 49 + 1;
    sys.fs.db.selectRowId(id);
    
    arg0[id] = random_str(sys.os.rnd() % 5 + 15);
    arg1[id] = random_str(sys.os.rnd() % 5 + 15);
    
    sys.fs.db.setEntryStr("key", arg0[id]);
    sys.fs.db.setEntryStr("val", arg1[id]);
    
    progress = i/2;
    upd_progress();
  }
}

function monkey_check {
  for (i = 1; i < 51; i++;) { 
    sys.fs.db.selectRowId(i);
    local key = sys.fs.db.getEntryStr("key", "Err");
    local val = sys.fs.db.getEntryStr("val", "Err");
    
    if ("" + arg0[i] != "" + key and "" + arg1[i] != "" + val) {
      print("Mismatch: key: " + key + " <- " + arg0[i] + " (" + i + ")");
      print("Mismatch: val: " + val + " <- " + arg1[i] + " (" + i + ")");
      FAIL = 1;
    }
    
    progress = i*2;
    upd_progress();
  }
}
